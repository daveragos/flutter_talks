---
import Layout from '../layouts/Layout.astro';
import TalkFilter from '../components/TalkFilter.astro';
import { format } from 'date-fns';
import { getCollection } from 'astro:content';
import '../styles/global.css';

const baseUrl = import.meta.env.BASE_URL;

// Fetch all talks from the content collection
const allTalks = await getCollection('talks');

// Sort talks by date (newest first)
const talks = allTalks
  .map(talk => ({
    ...talk.data,
    slug: talk.id,
  }))
  .sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime());

// Serialize talks for client-side use
const talksJson = JSON.stringify(talks);
const baseUrlJson = JSON.stringify(baseUrl);
---

<Layout title="Flutter Talks Collection">
  <div class="space-y-8">
    <div class="text-center py-10">
      <h1 class="text-4xl md:text-5xl font-extrabold text-white mb-2 drop-shadow">Flutter Talks Collection âœ¨</h1>
      <p class="text-lg md:text-xl text-blue-100 mb-6">Discover, share, and explore Flutter talks from conferences and events around the world.</p>
      <div class="flex flex-col sm:flex-row gap-4 justify-center items-center">
        <button 
          onclick="window.dispatchEvent(new CustomEvent('open-modal'))"
          class="inline-block px-6 py-3 bg-gradient-to-r from-purple-600 to-blue-600 text-white font-bold rounded-full shadow-lg hover:from-purple-700 hover:to-blue-700 transition"
        >
          ðŸš€ Submit a Talk
        </button>
        <a href={`${baseUrl}contribute/`} class="inline-block px-6 py-3 bg-white text-purple-800 font-bold rounded-full shadow hover:bg-blue-100 transition">Learn How to Contribute</a>
      </div>
    </div>

    <TalkFilter talks={talks} />

    <div 
      x-data={`{
        talks: ${talksJson},
        filteredTalks: ${talksJson},
        baseUrl: ${baseUrlJson},
        formatDate(dateString) {
          const date = new Date(dateString);
          return date.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
        },
        getThumbnail(thumbnail) {
          return thumbnail || this.baseUrl + 'images/flutter-talks-logo.png';
        },
        init() {
          // Listen for filter updates
          window.addEventListener('talks-filtered', (e) => {
            this.filteredTalks = e.detail.talks;
          });
        }
      }`}
      class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"
    >
      <template x-for="talk in filteredTalks" :key="talk.slug">
        <article class="bg-white rounded-2xl shadow-lg overflow-hidden hover:scale-105 hover:shadow-2xl transition-transform duration-200">
          <a :href="talk.videoUrl" target="_blank" rel="noopener noreferrer" class="block">
            <img
              :src="getThumbnail(talk.thumbnail)"
              :alt="talk.title"
              class="w-full aspect-video object-cover bg-gray-200"
              :onerror="'this.onerror=null; this.src=\'' + baseUrl + 'images/flutter-talks-logo.png\';'"
            />
            <div class="p-4">
              <h2 class="text-lg font-bold text-purple-900 mb-1" x-text="talk.title"></h2>
              <p class="text-xs text-blue-700 mb-1" x-text="talk.event"></p>
              <p class="text-xs text-gray-500 mb-2" x-text="formatDate(talk.date)"></p>
              <div class="flex flex-wrap gap-2">
                <template x-for="tag in talk.tags" :key="tag">
                  <span class="px-2 py-0.5 bg-purple-700 text-white text-xs rounded-full font-semibold" x-text="tag"></span>
                </template>
              </div>
            </div>
          </a>
        </article>
      </template>
      
      <!-- Empty State -->
      <div 
        x-show="filteredTalks.length === 0"
        class="col-span-full text-center py-12"
      >
        <p class="text-white text-xl mb-2">No talks found</p>
        <p class="text-blue-200">Try adjusting your filters</p>
      </div>
    </div>
  </div>
</Layout>
