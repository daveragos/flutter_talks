---
interface Props {
  githubRepo?: string;
  githubBranch?: string;
}

const { githubRepo = 'daveragos/flutter_talks', githubBranch = 'main' } = Astro.props;

// Create the x-data attribute content as a string to avoid nested template literal issues
const xDataContent = `{
    open: false,
    title: '',
    author: '',
    event: '',
    date: '',
    tags: '',
    videoUrl: '',
    thumbnail: '',
    videoLength: '',
    markdown: '',
    prUrl: '',
    filename: '',
    showResult: false,
    githubRepo: '${githubRepo}',
    githubBranch: '${githubBranch}',
    parseTimeToMinutes(timeString) {
      if (!timeString || !timeString.trim()) return null;
      const parts = timeString.trim().split(':').map(p => parseInt(p) || 0);
      if (parts.length === 2) {
        // MM:SS format
        return parts[0] + (parts[1] / 60);
      } else if (parts.length === 3) {
        // HH:MM:SS format
        return (parts[0] * 60) + parts[1] + (parts[2] / 60);
      }
      return null;
    },
    generateMarkdown() {
      const cleanTitle = this.title.trim();
      const cleanEvent = this.event.trim();
      const cleanDate = this.date.trim();
      const cleanTags = this.tags.split(',').map(t => t.trim()).filter(t => t);
      const cleanVideoUrl = this.videoUrl.trim();
      const cleanThumbnail = this.thumbnail.trim() || '/images/talks/placeholder.jpg';
      const videoLength = this.parseTimeToMinutes(this.videoLength);
      const year = cleanDate.slice(0, 4);

      let frontMatter = '---\\n' +
        'title: "' + cleanTitle.replace(/"/g, '\\\\"') + '"\\n' +
        'event: "' + cleanEvent.replace(/"/g, '\\\\"') + '"\\n' +
        'date: "' + cleanDate + '"\\n' +
        'year: "' + year + '"\\n' +
        'tags: [' + cleanTags.map(t => '"' + t.replace(/"/g, '\\\\"') + '"').join(', ') + ']\\n' +
        'thumbnail: "' + cleanThumbnail.replace(/"/g, '\\\\"') + '"\\n' +
        'videoUrl: "' + cleanVideoUrl.replace(/"/g, '\\\\"') + '"\\n';

      if (videoLength) {
        frontMatter += 'videoLength: ' + Math.round(videoLength) + '\\n';
      }

      frontMatter += '---\\n';

      this.markdown = frontMatter;

      const slug = cleanTitle
        .toLowerCase()
        .trim()
        .replace(/[^\\w\\s-]/g, '')
        .replace(/[\\s_-]+/g, '-')
        .replace(/^-+|-+$/g, '');
      this.filename = (slug || 'talk') + '.md';

      const filePath = 'src/content/talks/' + this.filename;
      const encodedContent = encodeURIComponent(this.markdown);
      this.prUrl = 'https://github.com/' + this.githubRepo + '/new/' + this.githubBranch + '?filename=' + encodeURIComponent(filePath) + '&value=' + encodedContent;

      // Automatically redirect to GitHub PR
      window.open(this.prUrl, '_blank');
    },
    resetForm() {
      this.title = this.author = this.event = this.date = this.tags = this.videoUrl = this.thumbnail = this.videoLength = '';
      this.markdown = '';
      this.prUrl = '';
      this.filename = '';
      this.showResult = false;
    },
    copyPrUrl() {
      navigator.clipboard.writeText(this.prUrl);
      alert('PR URL copied to clipboard!');
    }
  }`;
---
<div
  x-data={xDataContent}
  x-on:open-modal.window="open = true"
  x-show="open"
  x-cloak
  class="fixed inset-0 z-50 flex items-center justify-center bg-background/80 backdrop-blur-sm p-4"
>
  <div class="bg-card border border-border text-foreground rounded-3xl shadow-2xl w-full max-w-lg p-10 relative overflow-hidden" @click.away="open = false; resetForm()">
    <div class="absolute inset-x-0 top-0 h-1 bg-gradient-to-r from-primary/50 via-primary to-primary/50"></div>
    <button class="absolute top-6 right-6 text-muted-foreground hover:text-foreground transition-colors" @click="open = false; resetForm()" aria-label="Close">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
    </button>

    <h2 class="text-3xl font-black mb-2 tracking-tight">Submit Talk</h2>
    <p class="text-muted-foreground mb-8 text-sm font-medium">Contribute to the collective Flutter knowledge.</p>

    <form x-show="!showResult" @submit.prevent="generateMarkdown" class="space-y-6">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="space-y-2">
          <label class="text-xs font-bold uppercase tracking-widest text-muted-foreground">Talk Title</label>
          <input x-model="title" type="text" required class="w-full h-11 rounded-xl bg-secondary border border-border px-4 text-sm text-foreground focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary transition" placeholder="e.g. Flutter Rendering" />
        </div>
        <div class="space-y-2">
          <label class="text-xs font-bold uppercase tracking-widest text-muted-foreground">Speaker</label>
          <input x-model="author" type="text" class="w-full h-11 rounded-xl bg-secondary border border-border px-4 text-sm text-foreground focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary transition" placeholder="Jane Doe" />
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="space-y-2">
          <label class="text-xs font-bold uppercase tracking-widest text-muted-foreground">Event</label>
          <input x-model="event" type="text" required class="w-full h-11 rounded-xl bg-secondary border border-border px-4 text-sm text-foreground focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary transition" placeholder="FlutterCon 2024" />
        </div>
        <div class="space-y-2">
          <label class="text-xs font-bold uppercase tracking-widest text-muted-foreground">Date</label>
          <input x-model="date" type="date" required class="w-full h-11 rounded-xl bg-secondary border border-border px-4 text-sm text-foreground focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary transition" />
        </div>
      </div>

      <div class="space-y-2">
        <label class="text-xs font-bold uppercase tracking-widest text-muted-foreground">Tags (comma separated)</label>
        <input x-model="tags" type="text" required class="w-full h-11 rounded-xl bg-secondary border border-border px-4 text-sm text-foreground focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary transition" placeholder="UI, Performance, State Management" />
      </div>

      <div class="space-y-2">
        <label class="text-xs font-bold uppercase tracking-widest text-muted-foreground">Video URL</label>
        <input x-model="videoUrl" type="url" required class="w-full h-11 rounded-xl bg-secondary border border-border px-4 text-sm text-foreground focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary transition" placeholder="https://youtube.com/..." />
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="space-y-2">
          <label class="text-xs font-bold uppercase tracking-widest text-muted-foreground">Thumbnail</label>
          <input x-model="thumbnail" type="url" class="w-full h-11 rounded-xl bg-secondary border border-border px-4 text-sm text-foreground focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary transition" placeholder="/images/talks/..." />
        </div>
        <div class="space-y-2">
          <label class="text-xs font-bold uppercase tracking-widest text-muted-foreground">Duration</label>
          <input x-model="videoLength" type="text" pattern="^([0-9]{1,2}:)?[0-5]?[0-9]:[0-5][0-9]$" class="w-full h-11 rounded-xl bg-secondary border border-border px-4 text-sm text-foreground focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary transition" placeholder="MM:SS" />
        </div>
      </div>

      <button type="submit" class="w-full h-12 mt-4 rounded-xl bg-primary font-bold text-sm text-primary-foreground shadow-lg shadow-primary/20 hover:scale-[1.02] active:scale-[0.98] transition-all">
        Generate PR on GitHub
      </button>
    </form>
  </div>
</div>
