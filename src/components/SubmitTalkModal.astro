---
interface Props {
  githubRepo?: string;
  githubBranch?: string;
}

const { githubRepo = 'daveragos/flutter_talks', githubBranch = 'main' } = Astro.props;

// Create the x-data attribute content as a string to avoid nested template literal issues
const xDataContent = `{
    open: false,
    title: '',
    author: '',
    event: '',
    date: '',
    tags: '',
    videoUrl: '',
    thumbnail: '',
    videoLength: '',
    markdown: '',
    prUrl: '',
    filename: '',
    showResult: false,
    githubRepo: '${githubRepo}',
    githubBranch: '${githubBranch}',
    parseTimeToMinutes(timeString) {
      if (!timeString || !timeString.trim()) return null;
      const parts = timeString.trim().split(':').map(p => parseInt(p) || 0);
      if (parts.length === 2) {
        // MM:SS format
        return parts[0] + (parts[1] / 60);
      } else if (parts.length === 3) {
        // HH:MM:SS format
        return (parts[0] * 60) + parts[1] + (parts[2] / 60);
      }
      return null;
    },
    generateMarkdown() {
      const cleanTitle = this.title.trim();
      const cleanEvent = this.event.trim();
      const cleanDate = this.date.trim();
      const cleanTags = this.tags.split(',').map(t => t.trim()).filter(t => t);
      const cleanVideoUrl = this.videoUrl.trim();
      const cleanThumbnail = this.thumbnail.trim() || '/images/talks/placeholder.jpg';
      const videoLength = this.parseTimeToMinutes(this.videoLength);
      const year = cleanDate.slice(0, 4);
      
      let frontMatter = '---\\n' +
        'title: "' + cleanTitle.replace(/"/g, '\\\\"') + '"\\n' +
        'event: "' + cleanEvent.replace(/"/g, '\\\\"') + '"\\n' +
        'date: "' + cleanDate + '"\\n' +
        'year: "' + year + '"\\n' +
        'tags: [' + cleanTags.map(t => '"' + t.replace(/"/g, '\\\\"') + '"').join(', ') + ']\\n' +
        'thumbnail: "' + cleanThumbnail.replace(/"/g, '\\\\"') + '"\\n' +
        'videoUrl: "' + cleanVideoUrl.replace(/"/g, '\\\\"') + '"\\n';
      
      if (videoLength) {
        frontMatter += 'videoLength: ' + Math.round(videoLength) + '\\n';
      }
      
      frontMatter += '---\\n';
      
      this.markdown = frontMatter;
      
      const slug = cleanTitle
        .toLowerCase()
        .trim()
        .replace(/[^\\w\\s-]/g, '')
        .replace(/[\\s_-]+/g, '-')
        .replace(/^-+|-+$/g, '');
      this.filename = (slug || 'talk') + '.md';
      
      const filePath = 'src/content/talks/' + this.filename;
      const encodedContent = encodeURIComponent(this.markdown);
      this.prUrl = 'https://github.com/' + this.githubRepo + '/new/' + this.githubBranch + '?filename=' + encodeURIComponent(filePath) + '&value=' + encodedContent;
      
      // Automatically redirect to GitHub PR
      window.open(this.prUrl, '_blank');
    },
    resetForm() {
      this.title = this.author = this.event = this.date = this.tags = this.videoUrl = this.thumbnail = this.videoLength = '';
      this.markdown = '';
      this.prUrl = '';
      this.filename = '';
      this.showResult = false;
    },
    copyPrUrl() {
      navigator.clipboard.writeText(this.prUrl);
      alert('PR URL copied to clipboard!');
    }
  }`;
---
<div
  x-data={xDataContent}
  x-on:open-modal.window="open = true"
  x-show="open"
  x-cloak
  class="fixed inset-0 z-50 flex items-center justify-center bg-black/50"
>
  <div class="bg-blue-950 text-white rounded-2xl shadow-2xl w-full max-w-lg p-8 relative" @click.away="open = false; resetForm()">
    <button class="absolute top-4 right-4 text-gray-400 hover:text-white text-2xl" @click="open = false; resetForm()" aria-label="Close">√ó</button>
    <h2 class="text-2xl font-bold mb-6">Submit Your Flutter Talk</h2>
    <form x-show="!showResult" @submit.prevent="generateMarkdown" class="space-y-4">
      <div>
        <label class="block mb-1 font-semibold">Talk Title</label>
        <input x-model="title" type="text" required class="w-full rounded bg-blue-900/40 border border-blue-700 px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-purple-400" placeholder="e.g. Building Beautiful Flutter Apps" />
      </div>
      <div>
        <label class="block mb-1 font-semibold">Speaker/Author</label>
        <input x-model="author" type="text" class="w-full rounded bg-blue-900/40 border border-blue-700 px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-purple-400" placeholder="e.g. Jane Doe" />
      </div>
      <div>
        <label class="block mb-1 font-semibold">Event</label>
        <input x-model="event" type="text" required class="w-full rounded bg-blue-900/40 border border-blue-700 px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-purple-400" placeholder="e.g. FlutterCon USA 2024" />
      </div>
      <div>
        <label class="block mb-1 font-semibold">Date</label>
        <input x-model="date" type="date" required class="w-full rounded bg-blue-900/40 border border-blue-700 px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-purple-400" />
      </div>
      <div>
        <label class="block mb-1 font-semibold">Tags (comma separated)</label>
        <input x-model="tags" type="text" required class="w-full rounded bg-blue-900/40 border border-blue-700 px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-purple-400" placeholder="e.g. UI, Design, Flutter" />
      </div>
      <div>
        <label class="block mb-1 font-semibold">Video URL</label>
        <input x-model="videoUrl" type="url" required class="w-full rounded bg-blue-900/40 border border-blue-700 px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-purple-400" placeholder="https://youtube.com/watch?v=..." />
      </div>
      <div>
        <label class="block mb-1 font-semibold">Thumbnail URL</label>
        <input x-model="thumbnail" type="url" class="w-full rounded bg-blue-900/40 border border-blue-700 px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-purple-400" placeholder="/images/talks/your-thumbnail.jpg or https://..." />
      </div>
      <div>
        <label class="block mb-1 font-semibold">Video Length</label>
        <input 
          x-model="videoLength" 
          type="text" 
          pattern="^([0-9]{1,2}:)?[0-5]?[0-9]:[0-5][0-9]$"
          class="w-full rounded bg-blue-900/40 border border-blue-700 px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-purple-400" 
          placeholder="MM:SS or HH:MM:SS (e.g. 30:00 or 1:30:00)" 
        />
        <p class="text-xs text-blue-300 mt-1">Format: MM:SS or HH:MM:SS</p>
      </div>
      <button type="submit" class="w-full mt-4 py-2 rounded bg-gradient-to-r from-purple-500 to-blue-500 font-bold text-lg shadow hover:from-purple-600 hover:to-blue-600 transition">Submit & Create Pull Request</button>
    </form>
    <div x-show="showResult" x-transition class="mt-6">
      <h3 class="text-lg font-semibold mb-2">Your Markdown Entry</h3>
      <textarea readonly x-model="markdown" class="w-full h-48 rounded bg-blue-900/40 border border-blue-700 px-3 py-2 text-white mb-4 font-mono text-sm"></textarea>
      
      <div class="mb-4 p-3 rounded bg-blue-900/30 border border-blue-700">
        <p class="text-xs text-blue-200 mb-2"><strong>Filename:</strong> <code class="bg-blue-950 px-2 py-1 rounded">src/content/talks/<span x-text="filename"></span></code></p>
        <p class="text-xs text-blue-200">This file will be created when you click "Create Pull Request" below.</p>
      </div>
      
      <div class="flex flex-col gap-2">
        <a :href="prUrl" target="_blank" rel="noopener noreferrer" class="w-full py-3 rounded bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 font-bold text-lg text-center shadow-lg transition">
          üöÄ Create Pull Request
        </a>
        <div class="flex gap-2">
          <button @click="copyPrUrl()" class="flex-1 py-2 rounded bg-purple-600 hover:bg-purple-700 font-bold">Copy PR Link</button>
          <button @click="navigator.clipboard.writeText(markdown)" class="flex-1 py-2 rounded bg-blue-600 hover:bg-blue-700 font-bold">Copy Markdown</button>
          <a :href="'data:text/markdown;charset=utf-8,' + encodeURIComponent(markdown)" :download="filename" class="flex-1 py-2 rounded bg-indigo-600 hover:bg-indigo-700 font-bold text-center">Download</a>
        </div>
      </div>
      
      <div class="mt-4 p-3 rounded bg-blue-900/20 border border-blue-800">
        <p class="text-xs text-blue-300 mb-2"><strong>üìù Next Steps:</strong></p>
        <ol class="text-xs text-blue-200 list-decimal list-inside space-y-1">
          <li>Click "Create Pull Request" to open GitHub with your file pre-filled</li>
          <li>If you haven't forked the repo, GitHub will prompt you to fork it first</li>
          <li>Add your thumbnail image to <code class="bg-blue-950 px-1 rounded">public/images/talks/</code> if needed</li>
          <li>Review the file content and submit your PR</li>
        </ol>
      </div>
      
      <button @click="open = false; resetForm()" class="w-full mt-4 py-2 rounded bg-gray-700 hover:bg-gray-800 font-bold">Close</button>
    </div>
  </div>
</div> 